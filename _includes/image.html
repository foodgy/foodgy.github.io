{%- assign is_avatar = include.avatar | default: false -%}

{%- if is_avatar -%}
    {%- assign image_path = site.assets.images | append: site.author.image -%}
    {%- assign image_webp = image_path | split: '.' | first | append: '.webp' -%}
{%- else -%}
    {%- assign image_path = site.assets.images | append: page.name | remove: '.md' | append: '/' | append: include.img -%}
    {% assign image_webp = image_path | split: '.' | first | append: '.webp' %}
{%- endif -%}

{% assign webp_exists = site.static_files | where: "path", image_webp | first %}

{%- capture image_tag -%}
    <picture>
        {%- if webp_exists -%}
        <source type="image/webp" srcset="{{ image_webp }}">
        {%- endif -%}
        <img {% if is_avatar %} class="w-14 h-14 rounded-full mr-3.5" {% endif %}
            src="{{ image_path }}" alt="{{ include.alt | default: include.caption }}"
            {% if include.loading %} loading="{{ include.loading }}" {% endif %}>
    </picture>
{%- endcapture -%}

{%- if include.caption -%}
<figure class="mb-8">
    <a href="{{ include.link | default: image_path }}" target="_blank">
        {{ image_tag }}
    </a>
    <figcaption class="italic text-sm mt-3">
        {{ include.caption }}
    </figcaption>
</figure>
{%- else -%}
    {%- if include.link -%}
    <a href="{{ include.link | default: image_path }}" target="_blank">
        {{ image_tag }}
    </a>
    {%- else -%}
    <p>{{ image_tag }}</p>
    {%- endif -%}
{%- endif -%}