{%- assign image_folder = '/assets/img/' | append: page.name | remove: '.md' | append: '/' -%}
{%- assign image_path = image_folder | append: include.src -%}
{%- assign image_webp = image_path | split: '.' | first | append: '.webp' -%}

{%- assign webp_exists = site.static_files | where: "path", image_webp | first -%}

{%- capture image_tag -%}
    <picture>
        {%- if webp_exists -%}
        <source type="image/webp" srcset="{{ image_webp }}">
        {%- endif -%}
        <img src="{{ image_path }}" alt="{{ include.alt | default: include.caption }}"
            {% if include.loading %} loading="{{ include.loading }}" {% endif %}>
    </picture>
{%- endcapture -%}

{%- if include.caption -%}
<figure class="mb-8">
    <a href="{{ image_folder }}{{ include.link | default: include.src }}" target="_blank">
        {{ image_tag }}
    </a>
    <figcaption class="italic text-sm mt-3">
        {{ include.caption }}
    </figcaption>
</figure>
{%- else -%}
    {%- if include.link -%}
    <a href="{{ image_folder }}{{ include.link | default: include.src }}" target="_blank">
        {{ image_tag }}
    </a>
    {%- else -%}
    <p>{{ image_tag }}</p>
    {%- endif -%}
{%- endif -%}